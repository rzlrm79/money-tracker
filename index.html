<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Money Tracker</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7FBFA3">

<style>
body{
  margin:0;
  padding:16px;
  font-family:Arial, sans-serif;
  background:#F7F9F4;
  color:#2E3A34;
}

h1{
  text-align:center;
  color:#2F7D64;
}

.card{
  background:#FFFFFF;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  border:1px solid #E2E8E4;
}

input,select,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:12px;
  border:1px solid #E2E8E4;
  font-size:14px;
  box-sizing:border-box;
}

input,select{
  background:#F7F9F4;
}

button{
  background:#7FBFA3;
  color:#FFFFFF;
  font-weight:bold;
  border:none;
}

button:active{
  background:#6AAC93;
}

.item{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
  padding-bottom:6px;
  border-bottom:1px dashed #E2E8E4;
}

.income{ color:#2F7D64; }
.expense{ color:#E57373; }

.bar{
  height:10px;
  background:#7FBFA3;
  border-radius:6px;
  margin-bottom:10px;
}

small{ opacity:.75; }
</style>
</head>

<body>

<h1>ðŸ’° Money Tracker</h1>

<div class="card">
  <h3>Saldo</h3>
  <h2 id="saldo">Rp 0</h2>
</div>

<div class="card">
  <h3>Tambah Transaksi</h3>

  <input id="desc" placeholder="Keterangan">
  <input id="amount" type="number" placeholder="Jumlah">
  <input id="date" type="date">

  <select id="type">
    <option value="income">Pemasukan</option>
    <option value="expense">Pengeluaran</option>
  </select>

  <select id="category">
    <option>Makan</option>
    <option>Transport</option>
    <option>Rumah</option>
    <option>Gaji</option>
    <option>Lainnya</option>
  </select>

  <button onclick="addTx()">Tambah</button>
</div>

<div class="card">
  <h3>Grafik Pengeluaran</h3>

  <select id="monthFilter" onchange="drawChart()">
    <option value="all">Semua Bulan</option>
  </select>

  <div id="chart"></div>
</div>

<div class="card">
  <h3>Riwayat</h3>
  <div id="list"></div>
  <small>Tap = hapus â€¢ Tahan = edit</small>
</div>

<script>
let data = JSON.parse(localStorage.getItem('money-data') || '[]');

/* ===== UTIL ===== */
function rupiah(n){
  return 'Rp ' + n.toLocaleString('id-ID');
}

/* ===== MIGRASI DATA LAMA ===== */
function normalizeDates(){
  let changed = false;
  data = data.map(d=>{
    if(!d.date){
      changed = true;
      return {...d, date:new Date().toISOString().slice(0,10)};
    }
    return d;
  });
  if(changed){
    localStorage.setItem('money-data', JSON.stringify(data));
  }
}

/* ===== RENDER ===== */
function render(){
  let saldo = 0;
  const list = document.getElementById('list');
  list.innerHTML = '';

  data.forEach((d,i)=>{
    saldo += d.type==='income' ? d.amount : -d.amount;

    const div = document.createElement('div');
    div.className = 'item ' + d.type;
    div.innerHTML = `
      <span>${d.desc}<br><small>${d.category} â€¢ ${d.date}</small></span>
      <span>${rupiah(d.amount)}</span>
    `;

    div.onclick = () => {
      if(confirm('Hapus transaksi ini?')){
        data.splice(i,1);
        save();
      }
    };

    div.ontouchstart = () => div._t = setTimeout(()=>editTx(i),600);
    div.ontouchend = () => clearTimeout(div._t);

    list.appendChild(div);
  });

  document.getElementById('saldo').innerText = rupiah(saldo);
  drawChart();
}

/* ===== FILTER BULAN ===== */
function fillMonthFilter(){
  const sel = document.getElementById('monthFilter');
  const months = new Set();

  data.forEach(d=>{
    if(d.date) months.add(d.date.slice(0,7));
  });

  sel.innerHTML = '<option value="all">Semua Bulan</option>';

  [...months].sort().reverse().forEach(m=>{
    const opt = document.createElement('option');
    opt.value = m;
    opt.text = new Date(m+'-01')
      .toLocaleDateString('id-ID',{month:'long',year:'numeric'});
    sel.appendChild(opt);
  });
}

/* ===== GRAFIK ===== */
function drawChart(){
  const box = document.getElementById('chart');
  const filter = document.getElementById('monthFilter').value;
  box.innerHTML = '';

  let exp = data.filter(d=>d.type==='expense');

  if(filter !== 'all'){
    exp = exp.filter(d=>d.date.startsWith(filter));
  }

  if(!exp.length){
    box.innerHTML = '<small>Tidak ada pengeluaran</small>';
    return;
  }

  const map = {};
  exp.forEach(d=>{
    map[d.category] = (map[d.category]||0) + d.amount;
  });

  const max = Math.max(...Object.values(map));

  Object.entries(map).forEach(([cat,val])=>{
    box.innerHTML += `
      <small>${cat} â€” ${rupiah(val)}</small>
      <div class="bar" style="width:${val/max*100}%"></div>
    `;
  });
}

/* ===== CRUD ===== */
function addTx(){
  const desc = descEl.value;
  const amount = Number(amountEl.value);
  const type = typeEl.value;
  const category = categoryEl.value;
  const date = dateEl.value;

  if(!desc || !amount || !date){
    return alert('Lengkapi data');
  }

  data.unshift({ desc, amount, type, category, date });
  descEl.value='';
  amountEl.value='';
  dateEl.value = new Date().toISOString().slice(0,10);
  save();
}

function editTx(i){
  const d = data[i];
  const desc = prompt('Keterangan', d.desc);
  if(desc===null) return;
  const amt = prompt('Jumlah', d.amount);
  if(amt===null) return;
  const date = prompt('Tanggal (YYYY-MM-DD)', d.date);
  if(date===null) return;

  data[i] = {...d, desc, amount:Number(amt), date};
  save();
}

function save(){
  localStorage.setItem('money-data', JSON.stringify(data));
  fillMonthFilter();
  render();
}

/* ===== INIT ===== */
const descEl = document.getElementById('desc');
const amountEl = document.getElementById('amount');
const typeEl = document.getElementById('type');
const categoryEl = document.getElementById('category');
const dateEl = document.getElementById('date');

dateEl.value = new Date().toISOString().slice(0,10);

normalizeDates();
fillMonthFilter();
render();
</script>

</body>
</html>
